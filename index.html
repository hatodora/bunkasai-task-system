<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡åŒ–ç¥­ å½¹å“¡é€£çµ¡ã‚·ã‚¹ãƒ†ãƒ  (Firestore)</title>

    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;600:800;900&display-swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        /* ã‚«ã‚¹ã‚¿ãƒ Tailwindã‚¯ãƒ©ã‚¹ */
        @layer base {
            body {
                @apply font-sans bg-gray-100 text-gray-800 p-5;
            }
            h1 {
                @apply text-4xl font-extrabold text-gray-900 mb-6 pb-2 border-b-2 border-blue-500;
            }
            h2 {
                @apply text-2xl font-bold text-gray-800 mb-4 flex items-center;
            }
            .card {
                @apply bg-white rounded-2xl shadow-lg p-6 mb-6;
            }
            .btn-primary {
                @apply bg-blue-500 text-white py-2 px-5 rounded-lg font-semibold hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center space-x-2;
            }
            .btn-danger {
                @apply bg-red-500 text-white py-2 px-5 rounded-lg font-semibold hover:bg-red-600 transition-colors duration-200 flex items-center justify-center space-x-2;
            }
            .btn-secondary {
                @apply bg-gray-200 text-gray-800 py-2 px-5 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200 flex items-center justify-center space-x-2;
            }
            input[type="text"], select {
                @apply border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:border-blue-500;
            }
        }
    </style>
</head>
<body>

<div class="container mx-auto max-w-6xl">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-4xl font-extrabold text-gray-900 leading-tight">æ–‡åŒ–ç¥­ å½¹å“¡é€£çµ¡ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="text-3xl font-bold text-gray-700">
            <span id="currentTime">--:--:--</span>
        </div>
    </div>

    <div id="fullScreenAlert" class="fixed top-0 left-0 w-full h-full bg-red-600 text-white flex items-center justify-center text-center text-5xl font-black z-50 hidden cursor-pointer">
        <span id="fullScreenMessage">ç·Šæ€¥äº‹æ…‹ç™ºä»¤ä¸­ï¼</span>
    </div>

    <div class="card bg-yellow-50 border-l-8 border-yellow-400">
        <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
            <span class="material-icons-outlined text-yellow-500 text-3xl mr-2">notifications_active</span> ç·Šæ€¥é€£çµ¡ãƒœãƒ¼ãƒ‰
        </h2>
        <div id="activeSection" class="hidden">
            <p class="text-3xl font-bold text-red-600 mb-4" id="activeMessage">ç¾åœ¨ã€ç·Šæ€¥äº‹æ…‹ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™</p>
            <button id="resolveEmergencyButton" class="btn-primary bg-emerald-500 hover:bg-emerald-600">
                <span class="material-icons-outlined text-2xl mr-1">done_all</span> å•é¡Œè§£æ±ºã¨ã—ã¦è§£é™¤
            </button>
        </div>
        
        <div id="emergencySection">
            <label for="emergencyStatus" class="block text-sm font-medium text-gray-700 mb-2">ç·Šæ€¥äº‹æ…‹ç™ºä»¤</label>
            <div class="flex flex-col sm:flex-row gap-3">
                <select id="emergencyStatus" class="flex-grow">
                    <option value="">-- ç·Šæ€¥åº¦ã‚’é¸æŠ --</option>
                    <option value="æœ¬éƒ¨é›†åˆ">æœ¬éƒ¨é›†åˆ (è‡³æ€¥æœ¬éƒ¨ã«é›†åˆã—ã¦ãã ã•ã„)</option>
                     <option value="ç•°å¸¸æ°—è±¡">ç•°å¸¸æ°—è±¡ (æœ¬éƒ¨ã‹ã‚‰ã®æŒ‡ç¤ºã«å¾“ã£ã¦ãã ã•ã„)</option>
                    <option value="è½ã¨ã—ç‰©">å–¶æ¥­åœæ­¢ (è‡³æ€¥å„æ¨¡æ“¬åº—ã«é€šé”ã—ã¦ãã ã•ã„)</option>
                    <option value="ä½“èª¿ä¸è‰¯">æ¥å ´è€…ã®ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆ (è¤‡æ•°ã®äººã§å¯¾å¿œã—ã¦ãã ã•ã„)</option>
                    <option value="ç«äº‹">ç«äº‹ (å³æ™‚é¿é›£èª˜å°ã‚’è¡Œãªã£ã¦ãã ã•ã„)</option>
                    <option value="ãã®ä»–">ãã®ä»– (è©³ç´°å…¥åŠ›å¾Œã«ç™ºä»¤)</option>
                </select>
                <button id="issueEmergencyButton" class="btn-danger flex-shrink-0">
                    <span class="material-icons-outlined text-2xl mr-1">warning</span> ç™ºä»¤
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">ç™ºä»¤ã™ã‚‹ã¨å…¨ç”»é¢ã«é€šçŸ¥ã•ã‚Œã¾ã™ï¼ˆ5ç§’ã§è‡ªå‹•çµ‚äº†ã—ã¾ã™ï¼‰ã€‚</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="material-icons-outlined text-blue-500 text-3xl mr-2">add_task</span> æ–°è¦ã‚¿ã‚¹ã‚¯ã®è¿½åŠ 
            </h2>
            <form id="taskForm" class="space-y-4">
                <div>
                    <label for="taskName" class="block text-sm font-medium text-gray-700 mb-1">ã‚¿ã‚¹ã‚¯å / å ´æ‰€</label>
                    <input type="text" id="taskName" required placeholder="ä¾‹: â—‹â—‹æ•™å®¤ã®æº–å‚™" maxlength="50">
                </div>
                <div>
                    <label for="taskAssignee" class="block text-sm font-medium text-gray-700 mb-1">æ‹…å½“è€… / å›£ä½“å</label>
                    <input type="text" id="taskAssignee" required placeholder="ä¾‹: å®Ÿè¡Œå§”å“¡â—‹â—‹ / 3å¹´Açµ„" maxlength="30">
                </div>
                <div>
                    <label for="taskPriority" class="block text-sm font-medium text-gray-700 mb-1">å„ªå…ˆåº¦</label>
                    <select id="taskPriority" required>
                        <option value="é«˜">é«˜</option>
                        <option value="ä¸­">ä¸­</option>
                        <option value="ä½">ä½</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary w-full">
                    ã‚¿ã‚¹ã‚¯ã‚’ç™»éŒ²
                </button>
            </form>
        </div>

        <div class="card">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="material-icons-outlined text-blue-500 text-3xl mr-2">list_alt</span> å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§
            </h2>
            <div id="taskList" class="space-y-3">
                <p id="loadingIndicator" class="text-gray-500 text-sm">ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
        </div>
    </div>

    <div class="card mt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <span class="material-icons-outlined text-emerald-500 text-3xl mr-2">luggage</span> è½ã¨ã—ç‰©ãƒ»å¿˜ã‚Œç‰©æƒ…å ±
        </h2>
        <form id="lostItemForm" class="flex flex-col sm:flex-row gap-3 mb-4">
            <input type="text" id="lostItemDescription" placeholder="ä¾‹: èµ¤ã„è²¡å¸ƒ (â—‹â—‹ä»˜è¿‘ã§ç™ºè¦‹)" required class="flex-grow" maxlength="100">
            <input type="text" id="lostItemLocation" placeholder="ç™ºè¦‹å ´æ‰€" required class="w-full sm:w-1/4" maxlength="30">
            <button type="submit" class="btn-primary bg-emerald-500 hover:bg-emerald-600 flex-shrink-0">
                <span class="material-icons-outlined text-2xl mr-1">add_circle_outline</span> ç™»éŒ²
            </button>
        </form>
        
        <div id="lostItemList" class="space-y-3">
            <p class="text-gray-500 text-sm">è½ã¨ã—ç‰©ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
    </div>

    <div class="card mt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <span class="material-icons-outlined text-purple-500 text-3xl mr-2">people</span> æ··é›‘çŠ¶æ³
        </h2>
        <div class="flex flex-col sm:flex-row gap-3">
            <select id="congestionLocation" class="flex-grow">
                <option value="">-- å ´æ‰€ã‚’é¸æŠ --</option>
                <option value="æ ¡é–€">æ ¡é–€</option>
                <option value="ä½“è‚²é¤¨ä¼šè­°å®¤">ä½“è‚²é¤¨ä¼šè­°å®¤</option>
                <option value="æœ¬éƒ¨">æœ¬éƒ¨</option>
                <option value="ã‚µãƒ¬ã‚¸ã‚¢ãƒ³ãƒ¢ãƒ¼ãƒ«">ã‚µãƒ¬ã‚¸ã‚¢ãƒ³ãƒ¢ãƒ¼ãƒ«</option>
                <option value="èª¿ç†å ´">èª¿ç†å ´</option>
            </select>
            <select id="congestionLevel" class="flex-grow">
                <option value="">-- çŠ¶æ³ã‚’é¸æŠ --</option>
                <option value="ç©ºã„ã¦ã„ã‚‹">ç©ºã„ã¦ã„ã‚‹</option>
                <option value="æ™®é€š">æ™®é€š</option>
                <option value="ã‚„ã‚„æ··é›‘">ã‚„ã‚„æ··é›‘</option>
                <option value="æ··é›‘">æ··é›‘</option>
                <option value="å…¥å ´åˆ¶é™">å…¥å ´åˆ¶é™</option>
            </select>
            <button id="updateCongestionButton" class="btn-primary bg-purple-500 hover:bg-purple-600 flex-shrink-0">
                <span class="material-icons-outlined text-2xl mr-1">update</span> æ›´æ–°
            </button>
        </div>
        <div id="congestionList" class="mt-4 space-y-2">
            <p class="text-gray-500 text-sm">æ··é›‘çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // ----------------------------------------------------------------------
    // ğŸš¨ æœ€çµ‚ä¿®æ­£: Vercelã®ç’°å¢ƒå¤‰æ•°å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã€ã‚­ãƒ¼ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿ã¾ã™
    // ----------------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyCC3y2RqmnDyUOEp0fP3L78ucwrtCTC6Hk",
        authDomain: "bunkasai-task-system.firebaseapp.com",
        projectId: "bunkasai-task-system",
        storageBucket: "bunkasai-task-system.firebasestorage.app",
        messagingSenderId: "919831201875",
        appId: "1:919831201875:web:8e5d5c7d5b93a51c5f1ea6",
        // databaseURL: "https://bunkasai-task-system-default-rtdb.firebaseio.com", // Firestoreã§ã¯ä¸è¦
    };
    
    // Firebaseã®åˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOMè¦ç´ ã®å–å¾—
    const currentTimeSpan = document.getElementById('currentTime'); // æ™‚åˆ»è¡¨ç¤ºç”¨
    const taskForm = document.getElementById('taskForm');
    const taskList = document.getElementById('taskList');
    const lostItemForm = document.getElementById('lostItemForm');
    const lostItemList = document.getElementById('lostItemList');
    const issueEmergencyButton = document.getElementById('issueEmergencyButton');
    const resolveEmergencyButton = document.getElementById('resolveEmergencyButton');
    const emergencyStatusSelect = document.getElementById('emergencyStatus');
    const fullScreenAlert = document.getElementById('fullScreenAlert');
    const fullScreenMessage = document.getElementById('fullScreenMessage');
    const emergencySection = document.getElementById('emergencySection');
    const activeSection = document.getElementById('activeSection');
    const activeMessage = document.getElementById('activeMessage');
    const loadingIndicator = document.getElementById('loadingIndicator');
    // æ··é›‘çŠ¶æ³é–¢é€£
    const congestionLocationSelect = document.getElementById('congestionLocation');
    const congestionLevelSelect = document.getElementById('congestionLevel');
    const updateCongestionButton = document.getElementById('updateCongestionButton');
    const congestionList = document.getElementById('congestionList');


    let activeAlert = null;
    let alertIsActive = false;

    // ----------------------------------------------------------------------
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    // ----------------------------------------------------------------------

    /** ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã«æ•´å½¢ã™ã‚‹ */
    const formatTimestamp = (timestamp) => {
        if (!timestamp) return 'æ—¥æ™‚ä¸æ˜';
        const date = timestamp.toDate();
        return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', hour12: false });
    };

    /** ç¾åœ¨æ™‚åˆ»ã‚’æ›´æ–°ã™ã‚‹ */
    const updateTime = () => {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        if (currentTimeSpan) {
            currentTimeSpan.textContent = `${hours}:${minutes}:${seconds}`;
        }
    };
    // 1ç§’ã”ã¨ã«æ™‚åˆ»ã‚’æ›´æ–°
    setInterval(updateTime, 1000);
    updateTime(); // åˆæœŸè¡¨ç¤º

    // ----------------------------------------------------------------------
    // ã‚¿ã‚¹ã‚¯ç®¡ç†æ©Ÿèƒ½
    // ----------------------------------------------------------------------

    /** ã‚¿ã‚¹ã‚¯ã‚’Firestoreã«ä¿å­˜ã™ã‚‹ */
    taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('taskName').value;
        const assignee = document.getElementById('taskAssignee').value;
        const priority = document.getElementById('taskPriority').value;

        try {
            await db.collection('tasks').add({
                name,
                assignee,
                priority,
                completed: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            taskForm.reset();
        } catch (error) {
            console.error('ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ã«å¤±æ•—:', error);
            alert('ã‚¿ã‚¹ã‚¯ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    });

    /** ã‚¿ã‚¹ã‚¯ã®å®Œäº†çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹ */
    const toggleTask = async (id, completed) => {
        try {
            await db.collection('tasks').doc(id).update({ completed: !completed });
        } catch (error) {
            console.error('ã‚¿ã‚¹ã‚¯ã®æ›´æ–°ã«å¤±æ•—:', error);
        }
    };

    /** ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã™ã‚‹ */
    const deleteTask = async (id) => {
        try {
            await db.collection('tasks').doc(id).delete();
        } catch (error) {
            console.error('ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ã«å¤±æ•—:', error);
        }
    };

    /** ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ */
    const renderTasks = (snapshot) => {
        taskList.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢
        loadingIndicator.classList.add('hidden'); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã«

        if (snapshot.empty) {
            taskList.innerHTML = '<p class="text-gray-500 text-sm">ç¾åœ¨ã€å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        snapshot.forEach(doc => {
            const task = doc.data();
            const taskId = doc.id;
            const priorityColor = {
                'é«˜': 'bg-red-100 text-red-700 border-red-400',
                'ä¸­': 'bg-yellow-100 text-yellow-700 border-yellow-400',
                'ä½': 'bg-gray-100 text-gray-700 border-gray-400'
            }[task.priority] || 'bg-gray-100 text-gray-700 border-gray-400';

            const item = document.createElement('div');
            item.className = `flex items-center p-3 rounded-lg border ${priorityColor}`;
            if (task.completed) {
                item.classList.add('opacity-50', 'line-through');
            }

            item.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold text-base">${task.name}</p>
                    <p class="text-xs mt-0.5">${task.assignee} (${task.priority})</p>
                    <p class="text-xs text-gray-500 mt-1">ç™»éŒ²: ${formatTimestamp(task.createdAt)}</p>
                </div>
                <div class="flex space-x-2 flex-shrink-0">
                    <button class="toggle-btn text-emerald-500 hover:text-emerald-600" data-id="${taskId}" data-completed="${task.completed}">
                        <span class="material-icons-outlined text-2xl">${task.completed ? 'undo' : 'check_circle_outline'}</span>
                    </button>
                    <button class="delete-btn text-red-500 hover:text-red-600" data-id="${taskId}">
                        <span class="material-icons-outlined text-2xl">delete_outline</span>
                    </button>
                </div>
            `;
            taskList.appendChild(item);
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
        taskList.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                const completed = e.currentTarget.dataset.completed === 'true';
                toggleTask(id, completed);
            });
        });
        taskList.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    deleteTask(e.currentTarget.dataset.id);
                }
            });
        });
    };

    /** ã‚¿ã‚¹ã‚¯ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ */
    db.collection('tasks').orderBy('createdAt', 'desc')
        .onSnapshot(renderTasks, (error) => {
            console.error("ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
            loadingIndicator.textContent = 'ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        });

    // ----------------------------------------------------------------------
    // è½ã¨ã—ç‰©ç®¡ç†æ©Ÿèƒ½
    // ----------------------------------------------------------------------

    /** è½ã¨ã—ç‰©ã‚’Firestoreã«ä¿å­˜ã™ã‚‹ */
    lostItemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const description = document.getElementById('lostItemDescription').value;
        const location = document.getElementById('lostItemLocation').value;

        try {
            await db.collection('lostItems').add({
                description,
                location,
                resolved: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            lostItemForm.reset();
        } catch (error) {
            console.error('è½ã¨ã—ç‰©ã®è¿½åŠ ã«å¤±æ•—:', error);
        }
    });

    /** è½ã¨ã—ç‰©è§£æ±ºçŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹ */
    const resolveLostItem = async (id, resolved) => {
        try {
            await db.collection('lostItems').doc(id).update({ resolved: !resolved });
        } catch (error) {
            console.error('è½ã¨ã—ç‰©æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—:', error);
        }
    };

    /** è½ã¨ã—ç‰©ä¸€è¦§ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ */
    const renderLostItems = (snapshot) => {
        lostItemList.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢

        if (snapshot.empty) {
            lostItemList.innerHTML = '<p class="text-gray-500 text-sm">ç¾åœ¨ã€è½ã¨ã—ç‰©æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        snapshot.forEach(doc => {
            const item = doc.data();
            const itemId = doc.id;

            const itemDiv = document.createElement('div');
            itemDiv.className = `p-3 border rounded-lg flex justify-between items-center ${item.resolved ? 'bg-gray-50 opacity-60' : 'bg-white'}`;

            itemDiv.innerHTML = `
                <div class="flex-grow">
                    <p class="font-medium ${item.resolved ? 'line-through' : ''}">${item.description}</p>
                    <p class="text-xs text-gray-500 mt-0.5">ç™ºè¦‹å ´æ‰€: ${item.location} / ç™»éŒ²: ${formatTimestamp(item.createdAt)}</p>
                </div>
                <button class="resolve-btn text-emerald-500 hover:text-emerald-600 flex-shrink-0 ml-4" data-id="${itemId}" data-resolved="${item.resolved}">
                    <span class="material-icons-outlined text-2xl">${item.resolved ? 'undo' : 'done_all'}</span>
                </button>
            `;
            lostItemList.appendChild(itemDiv);
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
        lostItemList.querySelectorAll('.resolve-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                const resolved = e.currentTarget.dataset.resolved === 'true';
                resolveLostItem(id, resolved);
            });
        });
    };

    /** è½ã¨ã—ç‰©ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ */
    db.collection('lostItems').orderBy('createdAt', 'desc')
        .onSnapshot(renderLostItems, (error) => {
            console.error("è½ã¨ã—ç‰©ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        });

    // ----------------------------------------------------------------------
    // ç·Šæ€¥äº‹æ…‹ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½
    // ----------------------------------------------------------------------

    /** ç·Šæ€¥äº‹æ…‹ã®ç™ºä»¤ */
    issueEmergencyButton.addEventListener('click', async () => {
        const statusValue = emergencyStatusSelect.value;
        if (!statusValue) {
            alert('ç™ºä»¤ã™ã‚‹ç·Šæ€¥åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        try {
            // "emergency" ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã® "status" ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆ
            await db.collection('emergency').doc('status').set({
                value: statusValue,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log("ç·Šæ€¥äº‹æ…‹ã‚’ç™ºä»¤ã—ã¾ã—ãŸ:", statusValue);
        } catch (error) {
            console.error('ç·Šæ€¥äº‹æ…‹ã®ç™ºä»¤ã«å¤±æ•—:', error);
        }
    });

    /** ç·Šæ€¥äº‹æ…‹ã®è§£é™¤ */
    resolveEmergencyButton.addEventListener('click', async () => {
        if (!confirm('ç·Šæ€¥äº‹æ…‹ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        
        try {
            await db.collection('emergency').doc('status').delete();
            console.log("ç·Šæ€¥äº‹æ…‹ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚");
        } catch (error) {
            console.error('ç·Šæ€¥äº‹æ…‹ã®è§£é™¤ã«å¤±æ•—:', error);
        }
    });
    
    /** å…¨ç”»é¢é€šçŸ¥ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ï¼ˆä¸»ã«ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ */
    fullScreenAlert.addEventListener('click', () => {
        fullScreenAlert.classList.add('hidden');
        console.log("å…¨ç”»é¢é€šçŸ¥ã‚’æ‰‹å‹•è§£é™¤ã—ã¾ã—ãŸã€‚");
    });


    /** ç·Šæ€¥äº‹æ…‹ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ */
    db.collection('emergency').doc('status')
        .onSnapshot((doc) => {
            const status = doc.data();

            if (status && status.value) {
                // ç™ºä»¤ä¸­
                activeAlert = status.value;
                const timestamp = formatTimestamp(status.timestamp);
                
                // 1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã®è¡¨ç¤ºã‚’æ›´æ–° (æ°¸ç¶šè¡¨ç¤º)
                if (activeMessage) activeMessage.textContent = `${status.value} ç™ºç”Ÿ (${timestamp}) - å•é¡Œè§£æ±ºãƒœã‚¿ãƒ³ã§è§£é™¤`;
                if (emergencySection) emergencySection.classList.add('hidden');
                if (activeSection) activeSection.classList.remove('hidden');

                // 2. å…¨ç”»é¢é€šçŸ¥ã®è¡¨ç¤º
                if (!alertIsActive) {
                    alertIsActive = true;
                    if (fullScreenMessage) fullScreenMessage.textContent = status.value;
                    fullScreenAlert.classList.remove('hidden');
                    console.log("å…¨ç”»é¢é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚5ç§’å¾Œã«è‡ªå‹•çµ‚äº†ã—ã¾ã™ã€‚");

                    // 3. 5ç§’å¾Œã«å…¨ç”»é¢è¡¨ç¤ºã ã‘ã‚’çµ‚äº†ã™ã‚‹
                    setTimeout(() => {
                        fullScreenAlert.classList.add('hidden');
                        console.log("å…¨ç”»é¢é€šçŸ¥ã‚’è‡ªå‹•çµ‚äº†ã—ã¾ã—ãŸã€‚");
                    }, 5000);
                }

            } else {
                // è§£é™¤æ™‚
                activeAlert = null;
                alertIsActive = false;

                if (emergencySection) emergencySection.classList.remove('hidden');
                if (activeSection) activeSection.classList.add('hidden');
            }
        }, (error) => {
            console.error("ç·Šæ€¥äº‹æ…‹ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        });

    // ----------------------------------------------------------------------
    // æ··é›‘çŠ¶æ³ç®¡ç†æ©Ÿèƒ½
    // ----------------------------------------------------------------------

    /** æ··é›‘çŠ¶æ³ã‚’Firestoreã«ä¿å­˜ã™ã‚‹ */
    updateCongestionButton.addEventListener('click', async () => {
        const location = congestionLocationSelect.value;
        const level = congestionLevelSelect.value;

        if (!location || !level) {
            alert('å ´æ‰€ã¨çŠ¶æ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        try {
            // "congestion" ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ã€é¸æŠã•ã‚ŒãŸå ´æ‰€ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã¾ãŸã¯ä½œæˆ
            await db.collection('congestion').doc(location).set({
                level: level,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            congestionLocationSelect.value = ''; // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            congestionLevelSelect.value = '';
        } catch (error) {
            console.error('æ··é›‘çŠ¶æ³ã®æ›´æ–°ã«å¤±æ•—:', error);
        }
    });

    /** æ··é›‘çŠ¶æ³ä¸€è¦§ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ */
    const renderCongestion = (snapshot) => {
        congestionList.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢

        if (snapshot.empty) {
            congestionList.innerHTML = '<p class="text-gray-500 text-sm">ç¾åœ¨ã€æ··é›‘çŠ¶æ³ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        snapshot.forEach(doc => {
            const congestion = doc.data();
            const location = doc.id; // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDãŒå ´æ‰€åã«ãªã‚‹

            let levelColor = '';
            switch(congestion.level) {
                case 'ç©ºã„ã¦ã„ã‚‹': levelColor = 'text-green-600'; break;
                case 'æ™®é€š': levelColor = 'text-blue-600'; break;
                case 'ã‚„ã‚„æ··é›‘': levelColor = 'text-yellow-600'; break;
                case 'æ··é›‘': levelColor = 'text-orange-600'; break;
                case 'è¶…æº€å“¡': levelColor = 'text-red-600'; break;
                default: levelColor = 'text-gray-600'; break;
            }

            const itemDiv = document.createElement('div');
            itemDiv.className = `p-3 border rounded-lg flex justify-between items-center bg-white`;
            itemDiv.innerHTML = `
                <div class="flex-grow">
                    <p class="font-medium text-lg">${location}</p>
                    <p class="text-sm ${levelColor}">${congestion.level}</p>
                </div>
                <p class="text-xs text-gray-500 flex-shrink-0 ml-4">æœ€çµ‚æ›´æ–°: ${formatTimestamp(congestion.updatedAt)}</p>
            `;
            congestionList.appendChild(itemDiv);
        });
    };

    /** æ··é›‘çŠ¶æ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ */
    db.collection('congestion').orderBy('updatedAt', 'desc')
        .onSnapshot(renderCongestion, (error) => {
            console.error("æ··é›‘çŠ¶æ³ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        });

</script>
</body>
</html>
